import requests
import json
import re
from rapidfuzz import process, fuzz
import nltk
from nltk.corpus import words
import time
from nltk.stem import WordNetLemmatizer
from nltk.corpus import wordnet

# üîπ –°–∫–∞—á–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
nltk.download("words", quiet=True)
nltk.download("wordnet", quiet=True)
nltk.download("omw-1.4", quiet=True)

english_words = set(words.words())

# üîπ –°–ª–æ–≤–∞—Ä—å —Å–ª–µ–Ω–≥–∞ (–º–æ–∂–Ω–æ –ø–æ–ø–æ–ª–Ω—è—Ç—å)
slang_words = {
    # –±–∞–∑–æ–≤—ã–π –∫—Ä–∏–ø—Ç–æ-—Å–ª–µ–Ω–≥
    "gm", "gn", "rekt", "pamp", "dump", "moon", "lambo", "hodl", "fomo", "jomo",
    "ngmi", "wagmi", "btd", "btdi", "btfd", "ape", "apestrong", "shill", "rug",
    "rugged", "rugpull", "bagholder", "bags", "degen", "paperhands", "diamondhands",
    "whale", "shrimp", "pleb", "sat", "sats", "stacking", "stackingsats", "alpha",
    "beta", "gigachad", "plebs", "autist", "autistic", "ser", "frens", "wagie",
    "anon", "broski", "chad", "giga", "apeing", "apes", "cope", "copeium", "copium",
    "hopium", "moonbois", "moonboy", "moonboys", "lasereyes", 'virtual', 'memecoins',

    # —Ç–∏–∫–µ—Ä—ã –∏ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã
     "wojak", "memecoin", "alts", "alt",

    # —Ç–æ—Ä–≥–æ–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
    "long", "short", "pump", "dump", "flippening", "alltimehigh", "ath", "dip",
    "buythedip", "sellthetop", "moonshot", "parabolic", "gigapump", "gigadump",
    "bottom", "top", "bullrun", "bearrun", "capitulation", "deadcat", "doubletop",
    "doublebottom", "rangebound", "sideways", "exitliquidity", "bagging",

    # NFT / Web3
    "floor", "mint", "minted", "airdrop", "drop", "gmers", "degenmint", "delist",
    "delisted", "flooring", "sweep", "sweeping", "wagmiarmy", "metaverse",
    "metaversebro", "pfp", "pfps", "jpeg", "jpegs", "rightclicksave", "opensea",
    "blur", "rarible", "magiceden", "onchain", "offchain", "dao", "defi",
    "shitcoin", "shitcoins", "shitcoiner", "tokenomics", "ponzinomics",

    # —ç–º–æ—Ü–∏–∏ –∏ –º–µ–º—ã
    "lol", "lmao", "rofl", "kek", "xd", "vibe", "sus", "yeet", "bruh", "pog",
    "poggers", "smh", "idk", "irl", "afk", "imo", "imho", "geez", "noob", "ezpz",
    "wheee", "stonks", "stonk", "tendies", "yolo", "apein", "apeout", "fud",
    "fudding", "based", "cringe", "vibin", "glhf", "pwned", "owned", "clown",
    "clownworld", "sadge", "monkaS", "peepo", "omegalul", "lulw", "lul", "5head",
    "galaxybrain", "npc", "seethe", "kekw", "xdd", "gigachad", "soyboy", "simp",
    "doomer", "bloomer", "coomer", "boomer", "zoomer", "sigma", "betaorbiter",
    "topg", "gyatt",

    # –ø—Ä–æ—á–µ–µ —Å–µ—Ç–µ–≤–æ–µ
    "np", "idc", "ffs", "omg", "wtf", "gg", "ez", "wp", "lfg", "goat", "mfers",
    "toobased", "vitalik", "satoshi", "elon", "cz", "bro", "bros", "fam", "irlbro",
    "basedgod", "shitpost", "shitposter", "shitposting", "okboomer", "okzoomers",
    "degens", "gigabrain", "megalul", "bigbrain", "smartmoney", "newbie", "pajeet",
    "wagmiarmy", "anonarmy", "pumpndump", "insiders", "apestrong", "hodler",
    "cryptobros", "cryptobro", "moonmission", "diamondhanded", "paperhanded", "nft"
}

extended_slang = slang_words | {w + "s" for w in slang_words}

def is_english_word(word: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–ª–æ–≤–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–º:
    1) –ï—Å—Ç—å –ª–∏ –æ–Ω–æ –≤ nltk.corpus.words
    2) –ï—Å—Ç—å –ª–∏ –¥–ª—è –Ω–µ–≥–æ —Ö–æ—Ç—å –æ–¥–∏–Ω synset –≤ WordNet
    """
    if word in english_words:
        return True
    if wordnet.synsets(word):  # –µ—Å—Ç—å –ª–∏ —Å–∏–Ω–æ–Ω–∏–º—ã –≤ wordnet
        return True
    return False

def fetch_top_coins_with_pairs(output_path="tickers_pairs.json",
                               min_market_cap=20_000_000,
                               min_volume=1000,
                               max_pages=10):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–Ω–µ—Ç—ã —Å CoinGecko, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ–±—ä–µ–º—É —Ç–æ—Ä–≥–æ–≤,
    –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–∞—Ä—ã —Ç–∏–∫–µ—Ä -> –ø–æ–ª–Ω–æ–µ –∏–º—è –≤ JSON.
    –° –ª–æ–≥–∞–º–∏: —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤, –æ–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏ –ª–∏–º–∏—Ç–µ API.
    """
    import time, requests, json, re

    url = "https://api.coingecko.com/api/v3/coins/markets"
    params = {"vs_currency": "usd", "order": "market_cap_desc", "per_page": 250, "page": 1}

    ticker_name_pairs = dict()
    pattern = re.compile(r"^[a-z0-9]+$")

    while params["page"] <= max_pages:
        print(f"üîπ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É {params['page']}...")
        for attempt in range(5):
            try:
                response = requests.get(url, params=params)
                if response.status_code == 429:  # Too Many Requests
                    wait_time = 10 * (attempt + 1)
                    print(f"‚ö†Ô∏è –õ–∏–º–∏—Ç API, –∂–¥—ë–º {wait_time} —Å–µ–∫...")
                    time.sleep(wait_time)
                    continue
                response.raise_for_status()
                break
            except requests.exceptions.HTTPError as e:
                wait_time = 5
                print(f"‚ùå –û—à–∏–±–∫–∞ {e}, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time} —Å–µ–∫...")
                time.sleep(wait_time)
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –≤—ã—Ö–æ–¥–∏–º")
            break

        data = response.json()
        if not data:
            print("‚ö†Ô∏è –ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –≤—ã—Ö–æ–¥–∏–º")
            break

        new_pairs = 0
        for coin in data:
            market_cap = coin.get("market_cap") or 0
            volume = coin.get("total_volume") or 0
            if market_cap >= min_market_cap and volume >= min_volume:
                name = coin["name"].lower().replace(" ", "")
                symbol = coin["symbol"].lower()
                if 2 <= len(symbol) <= 10 and pattern.match(symbol):
                    if symbol not in ticker_name_pairs:
                        ticker_name_pairs[symbol] = name
                        new_pairs += 1

        print(f"‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {params['page']} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞, –¥–æ–±–∞–≤–ª–µ–Ω–æ {new_pairs} –Ω–æ–≤—ã—Ö –ø–∞—Ä, –≤—Å–µ–≥–æ {len(ticker_name_pairs)}")
        params["page"] += 1
        time.sleep(1)  # –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å 429

    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(ticker_name_pairs, f, ensure_ascii=False, indent=2)

    print(f"üéâ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(ticker_name_pairs)} –ø–∞—Ä —Ç–∏–∫–µ—Ä->–∏–º—è –≤ {output_path}")


lemmatizer = WordNetLemmatizer()

def find_crypto_mentions_v2(text, ticker_name_pairs, threshold=85):
    text = text.lower()
    words_in_text = re.findall(r"[a-zA-Z0-9$]+", text)

    matches = set()
    tickers = list(ticker_name_pairs.keys())
    names = list(ticker_name_pairs.values())

    for word in words_in_text:
        if len(word) < 2:
            continue

        lemma = lemmatizer.lemmatize(word, wordnet.NOUN)
        lemma = lemmatizer.lemmatize(lemma, wordnet.VERB)

        if is_english_word(lemma):
            continue
        if word in extended_slang or lemma in extended_slang:
            continue

        # üîπ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ç–∏–∫–µ—Ä–æ–º
        if word in tickers:
            matches.add(word)
            continue

        # üîπ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –∏–º–µ–Ω–µ–º
        if word in names:
            # –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–∏–∫–µ—Ä
            ticker = [t for t, n in ticker_name_pairs.items() if n == word][0]
            matches.add(ticker)
            continue

        # üîπ fuzzy —Ç–∏–∫–µ—Ä
        result = process.extractOne(word, tickers, scorer=fuzz.ratio, score_cutoff=threshold)
        if result:
            candidate, score, _ = result
            if score >= 80 and (len(word) >= 4 or score > 92):
                matches.add(candidate)
                continue

        # üîπ fuzzy –∏–º—è
        result = process.extractOne(word, names, scorer=fuzz.ratio, score_cutoff=threshold)
        if result:
            candidate_name, score, _ = result
            if score >= 80 and (len(word) >= 4 or score > 92):
                ticker = [t for t, n in ticker_name_pairs.items() if n == candidate_name][0]
                matches.add(ticker)

    matches = {m for m in matches if m not in slang_words}
    return sorted(matches)

# --- –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã ---
fetch_top_coins_with_pairs("clean_names_and_symbols.json")

with open("clean_names_and_symbols.json", "r", encoding="utf-8") as f:
    tickers = json.load(f)

text = """Brooo frens, last night $BTC did some giga-wick sh*t ‚Äî candle went full ‚úàÔ∏è then insta-dumped, ngl my stop got rekted hard af üíÄ.  
Meanwhile ethreum (ETHh, eeth) gas still ridic, ppl saying ‚ÄúL2s fix this‚Äù, but zk-rollp testnet rugged again lmao.  
Some anon shilln SOLnaa (aka $SOL) claiming ‚Äúhyperdrive subnetz online soon‚Äù, but network went kaput AGAIN, validators crying on X (ex-Twitter ü§°).  

Bruh polkad0t fam still chanting parachain mantra since 2020, but chart = ü™¶. Cardaaano maxis screaming ‚ÄúCharles = Satoshi‚Äù ü§Ø, but ada price = sideways crab walk ü¶Ä.  
DOGEE and shiebha memelords raiding TikTok comments, normies FOMO into $INU derivatives (floppaInu, babyShibX, shibariooo) ‚Äî pure ponzi-nomics.  
My fren YOLO‚Äôd into arbitrrum (arbz), opmtmism (oppp), zkSnyc (yes spelled like that ü§£), claiming ‚Äúnext ETH killer bro frfr‚Äù, but it‚Äôs just bridge exploits & farm dumpers.  

Saw whale addys moving giga bags: $ETH to CEX, $USDT to Tron chain, some shady zkBob bridge, ngmi vibes.  
CT (crypto Twitter) screaming about pepe v2, wojackX, gme-moon, and giga-sussy memecoins like $KAREN2.0, $BROKEAF, $CLOWNPEPE ü§°.  
Even rugdevs dropping new pump-n-dumps: elonnInuuuu, xShrek, mcdoge420, gigaFLOP ‚Äî ppl apin‚Äô like brainless bots ü§ñ.  

Meanwhile $BNB maxis copin ‚ÄúCZ strong‚Äù, but Binance FUD trending daily. FTX ghost memez ‚Äî ppl still posting ‚ÄúSBF speedrun jail any%‚Äù üòÇ.  
XRP army still in cope mode: ‚Äúsettlement tmrrw bros!!‚Äù ‚Äî been sayin‚Äô this since 2017 lmao.  
Litec0in cultists say halving = moon üöÄ, but chart = giga meh. Tron (TRXx) shills push ‚ÄúSun‚Äôs plan‚Äù every week, no devs, only hype.  

Some weird alpha droppin on Discord: ‚ÄúVirtualzz DAO‚Äù + ‚ÄúMetaApesChain‚Äù legit 100x vibes‚Ä¶ until u read contract: owner = 1 wallet kek.  
Others pushing zkPonzi, DeFi rugs, ppl still farming ‚Äúyield‚Äù on chains no one heard of: futrcashX, safemoonV3, rugSwap, frogDEX.  
Nft bros crying: floor bleed out, ape jpegs = dust, ppl postin gm ser with giga cope ü•≤.  

Honestly chartz lookin giga-sus, volume ded, liquidity poolz empty.  
Ppl yelling ‚ÄúWAGMI‚Äù but whales unload quietly‚Ä¶ not fin adv, just vibes.  
Bruh ngmi if u still ape top tick on memecoins spelled with 5 typos üíÄ.

"""
mentions = find_crypto_mentions_v2(text, tickers)
print(mentions)